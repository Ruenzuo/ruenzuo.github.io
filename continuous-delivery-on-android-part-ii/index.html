<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    
    <title>Continuous Delivery on Android - Part II</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Open+Sans:700,400" />

    
    <meta name="generator" content="Ghost 0.3" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="/rss/">
</head>
<body class="post-template">

    
    



<main class="content" role="main">

    <article class="post">

        
        <header class="post-header">
            <a id="blog-logo" href="http://ruenzuo.github.io">
                
                    Ruenzuo.io
                
            </a>
        </header>

        
        

        
        <span class="post-meta"><time datetime="2013-11-26">26 Nov 2013</time> </span>

        <h1 class="post-title">Continuous Delivery on Android - Part II</h1>

        <section class="post-content">
            <p>This is the second part of my post about continuous delivery setup on Android using <a href="http://www.gradle.org/">gradle</a>, <a href="https://travis-ci.org/">Travis</a> and <a href="https://www.testflightapp.com/">TestFlight</a>. For this part, I'll be referencing this <a href="https://github.com/Ruenzuo/android-cd-travis-example">repository</a>. If you're interested in what is continuous delivery or what are the motivations and goals of it be sure to check the <a href="http://ruenzuo.github.io/continuous-delivery-on-android-part-i/">first part</a> of this post.</p>

<p>When we finish you'll be dancing like our little friend.</p>

<p><img src="https://dl.dropboxusercontent.com/u/99114459/dancing-android.gif" alt="dancing-android" /></p>

<hr />

<h3 id="gradle">Gradle</h3>

<p>Gradle has been chosen by Google's ADT team to be Android's <a href="http://tools.android.com/tech-docs/new-build-system/user-guide">next build system</a> so Ant support will be dropped sometime in the future. The following assumes that you have basic knowledge about Android's gradle plugin and Groovy domain-specific language.</p>

<p>I'll make a brief explanation of my <code>build.gradle</code> file shown below in 3 sections:</p>

<ul>
<li>Build configurations</li>
<li>Product flavors</li>
<li>Dependencies</li>
</ul>

<script src="https://gist.github.com/Ruenzuo/7668340.js"></script>

<h5 id="buildconfigurations">Build Configurations</h5>

<p>For this example, I'm using <code>targetSdkVersion 18</code> and <code>buildToolsVersion "18.0.1"</code>.</p>

<p>I'm setting <code>debuggable true</code> and <code>zipAlign true</code> on the default debug build type because this will be the APK I'll be delivering with TestFlight. </p>

<h5 id="productflavors">Product flavors</h5>

<p>I'm adding two product flavors <code>free</code> and <code>paid</code>. You need to configure your project <code>src</code> directory to something like <a href="https://github.com/Ruenzuo/android-cd-travis-example/tree/master/WeatherApp/src">this</a> so gradle can grab the correct files for compiling each version. You're free to add different resources for each version, for instance, you can add <strong>different application icons</strong> (<a href="https://github.com/Ruenzuo/android-cd-travis-example/blob/master/WeatherApp/src/free/res/drawable-hdpi/ic_launcher.png">free</a> and <a href="https://github.com/Ruenzuo/android-cd-travis-example/blob/master/WeatherApp/src/paid/res/drawable-hdpi/ic_launcher.png">paid</a> icons) on each <code>res</code> directory.</p>

<p>For each product flavor, I'm configuring a different <code>packageName</code>, in order to be able to <strong>install both versions on the same device</strong>, and adding a <code>buildConfig</code> variable which can be used from anywhere on the project, for example: <strong>to enable or disable features</strong> on the <a href="https://github.com/Ruenzuo/android-cd-travis-example/blob/master/WeatherApp/src/main/java/com/ruenzuo/weatherapp/base/CitiesBaseActivity.java#L49">base code</a> or <strong>to test specific features for each build</strong> on your <a href="https://github.com/Ruenzuo/android-cd-travis-example/blob/master/WeatherApp/src/instrumentTest/java/com.ruenzuo.weatherapp.test/CitiesActivityFunctionalTests.java#L28">tests</a>.</p>

<h5 id="dependencies">Dependencies</h5>

<p>With gradle, you can also specify specific product flavor dependencies, to make APK lighter, and exclude transitive dependencies, so compiler doesn't complain about duplicated files on compilation. In this example, we don't need to compile <code>libs/GoogleAdMobAdsSdk-6.4.1.jar</code> on paid version because its not referenced. </p>

<h3 id="travis">Travis</h3>

<p>Travis is a is a hosted continuous integration service for the open source community. It's fully integrated with GitHub. The following asumes that you have basic knowledge about Travis, unix shell and Android command line tools.</p>

<p>I'll explain the most important parts of my <code>.travis.yml</code> file shown below in 5 sections:</p>

<ul>
<li>Branches</li>
<li>Before install</li>
<li>Install</li>
<li>Before script</li>
<li>Script</li>
</ul>

<script src="https://gist.github.com/Ruenzuo/7668407.js"></script>

<h5 id="branches">Branches</h5>

<p>In this part, I'm telling Travis to <strong>build only master branch</strong>. Any commit on the master branch will trigger a build, but this can be avoided by adding <code>[ci skip]</code> to the <a href="https://github.com/Ruenzuo/android-cd-travis-example/commit/5a5f37b18bd822075f33d00087ceb217cf0e0798">commit message</a>.</p>

<h5 id="beforeinstall">Before install</h5>

<p>Sadly, Travis doesn't offer an Android development environment so we need to install everything by our own. This is done on <code>before_install</code> part of the script.</p>

<h5 id="install">Install</h5>

<p>I'm skipping the default <code>install</code> behaivour of Travis described <a href="http://about.travis-ci.org/docs/user/languages/java/#Projects-Using-Gradle">here</a>, because I really don't need it, I'm using gradle wrapper which I think it's the best.</p>

<h5 id="beforescript">Before script</h5>

<p>On <code>before_script</code> I'm using <a href="https://github.com/Ruenzuo/android-cd-travis-example/blob/master/Scripts/wait_for_emulator.sh">this</a> script to launch the simulator and wait until it's ready, then I'm using <code>adb shell input keyevent 82 &amp;</code> which gives the virtual device an unlock message.</p>

<h5 id="script">Script</h5>

<p>Finally, on <code>script</code> I'm using the gradle wrappler to run instrument tests, this task will also generate debug APK both for free and paid flavors on the following path <code>$TRAVIS_BUILD_DIR/WeatherApp/build/apk/</code>. The rest of the script will be described on the next topic. </p>

<h3 id="testflight">TestFlight</h3>

<p>TestFlight is a free platform used to distribute beta and internal iOS/Android applications to team members over-the-air. The following asumes that you have basic knowledge about the service.</p>

<p>As we seen on the last section <code>script</code> of the <code>.travis.yml</code> file, I'm using <code>curl</code> to upload both APKs to TestFlight API adding <code>distribution_lists</code> parameter so <strong>each version is distributed to a different set of recipients</strong>.</p>

<p>For this, you need to create and configure two applications on TestFlight:</p>

<p><img src="https://dl.dropboxusercontent.com/u/99114459/testflight.png" alt="testflight" /></p>

<p>Get the <code>api_token</code> and <code>team_token</code> from TestFlight and create the desired number of <code>distribution_lists</code>. You can find this option on the bottom of the People section of the webpage:</p>

<p><img src="https://dl.dropboxusercontent.com/u/99114459/distribution-lists.png" alt="distribution-lists" /></p>

<p>Remember that you can specify if you want to <code>notify</code> those users about a new build. Another cool thing you can do is to add <code>notes</code> for the build information, here you can use Travis <a href="http://about.travis-ci.org/docs/user/ci-environment/#Environment-variables">environment variables</a> to add interesting information to those notes.</p>

<hr />

<h3 id="closing">Closing</h3>

<p>Hopefully you get everything right. But if not, just send me an an email to <a href='mailto:renzo.crisostomo@me.com'>renzo.crisostomo@me.com</a>. Good luck and thanks for reading.</p>
        </section>

        <footer class="post-footer">

            
                <section class="author">
                    <h4>Renzo Cris√≥stomo</h4>
                    <p></p>
                </section>
            

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Continuous Delivery on Android - Part II&url=http://ruenzuo.github.io/continuous-delivery-on-android-part-ii/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://ruenzuo.github.io/continuous-delivery-on-android-part-ii/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://ruenzuo.github.io/continuous-delivery-on-android-part-ii/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>

        

    </article>

</main>

    <footer class="site-footer">
        <a class="subscribe icon-feed" href="http://ruenzuo.github.io/rss/"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
             <section class="copyright">All content copyright <a href="/">Ruenzuo.io</a> &copy; 2013 &bull; All rights reserved.</section>
             <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://ghost.org">Ghost</a></section>
        </div>
    </footer>

    
    <script src="/shared/vendor/jquery/jquery.js"></script>

    
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>